package com.geek.shengka.content.controller;

import com.geek.shengka.common.annotation.IgnoreClientToken;
import com.geek.shengka.common.basemodel.BaseResponse;
import com.geek.shengka.content.entity.vo.UpdatePublishVideoCreateTime;
import com.geek.shengka.content.enums.RecommendEnum;
import com.geek.shengka.content.mapper.SkPublishVideoDAO;
import com.geek.shengka.content.service.recommand.RedisService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.CollectionUtils;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.List;

@RestController
@RequestMapping("/v1/init/topvideo")
@IgnoreClientToken
public class InitTopVideoController {
	
    private static final Logger logger = LoggerFactory.getLogger(InitTopVideoController.class);
    @Autowired
    private RedisService redisService;
    
    @Autowired
    private SkPublishVideoDAO skPublishVideoDAO;

    @GetMapping("")
    @IgnoreClientToken
	public BaseResponse initTopVideo() {
    	redisService.del(RecommendEnum.SMALLVIDEOTOTAL.getKey());
        String[] topIds=new String[]{"614789143928791040","614789143928791049","614789143928791052","614789143928791058","614789143928791061","614789143928791064","614789143928791066","614789143928791072","614789143928791086","614789143928791087","614789143928791088","614789144016871435","614789144016871438","614789144016871443","614789144016871444","614789144016871445","614789144016871447","614789144016871451","614789144016871455","614789144016871459","614789144016871468","614789144016871469","614789144088174602","614789144088174605","614789144088174607","614789144088174610","614789144088174611","614789144088174613","614789144088174617","614789144088174618","614789144088174633","614789144088174635","614789144088174636","614789144163672068","614789144163672072","614789144163672073","614789144163672076","614789144163672077","614789144163672078","614789144163672080","614789144163672082","614789144163672089","614789144163672093","614789144163672096","614789144163672097","614789144163672098","614789144163672101","614789144163672105","614789144163672108","614789144234975232","614789144234975241","614789144234975242","614789144234975245","614789144234975246","614789144234975264","614789144234975265","614789144234975273","614789144234975274","614789144314667009","614789144314667010","614789144314667017","614789144314667020","614789144314667026","614789144314667027","614789144314667041","614789144314667044","614789144314667046","614789144314667048","614789144314667055","614789144314667057","614789144390164480","614789144390164483","614789144390164492","614789144390164495","614789144390164496","614789144390164500","614789144390164516","614789144390164517","614789144390164519","614789144390164522","614789144390164527","614789144478244867","614789144478244874","614789144478244880","614789144478244881","614789144478244884","614789144478244886","614789144478244892","614789144478244898","614789144478244905","614789144478244909","614789144478244911","614789144478244913","614789144562130951","614789144562130955","614789144562130958","614789144562130964","614789144562130965","614789144562130972","614789144562130975","614789144562130981","614789144562130990","614789144650211331","614789144650211332","614789144650211333","614789144650211334","614789144650211336","614789144650211337","614789144650211349","614789144650211351","614789144650211354","614789144650211370","614789144650211373","614789144650211374","614789144746680327","614789144746680337","614789144746680340","614789144746680346","614789144746680348","614789144746680353","614789144746680365","614789144746680367","614789144847343618","614789144847343624","614789144847343625","614789144847343635","614789144847343636","614789144847343638","614789144847343640","614789144847343649","614789144847343652","614789144847343654","614789144847343657","614789144847343659","614789144948006916","614789144948006918","614789144948006919","614789144948006920","614789144948006922","614789144948006934","614789144948006936","614789144948006937","614789144948006942","614789144948006950","614789144948006951","614789144948006952","614789144948006954","614789144948006959","614789145048670217","614789145048670218","614789145048670223","614789145048670224","614789145048670237","614789145048670238","614789145048670240","614789145048670245","614789145048670246","614789145048670247","614789145048670252","614789145153527814","614789145153527819","614789145153527820","614789145153527821","614789145153527822","614789145153527830","614789145153527834","614789145153527836","614789145153527837","614789145153527843","614789145153527848","614789145153527852","614789145153527856","614789145258385411","614789145258385413","614789145258385416","614789145258385418","614789145258385429","614789145258385432","614789145258385435","614789145258385438","614789145363243012","614789145363243018","614789145363243019","614789145363243033","614789145363243039","614789145363243043","614789145363243053","614789145476489221","614789145476489222","614789145476489225","614789145476489236","614789145476489237","614789145476489238","614789145476489239","614789145476489242","614789145476489246","614789145476489259","614789145476489260","614789145476489265","614789145589735424","614789145589735439","614789145589735442","614789145589735450","614789145589735458","614789145589735459","614789145589735461","614789145715564547","614789145715564548","614789145715564554","614789145715564555","614789145715564558","614789145715564571","614789145715564575","614789145715564580","614789145715564584","614789145715564586","614789145715564587","614789145715564588","614789145833005057","614789145833005074","614789145833005077","614789145833005080","614789145833005096","614789145967222784","614789145967222788","614789145967222798","614789145967222800","614789145967222804","614789145967222807","614789145967222809","614789145967222816","614789145967222818","614789145967222831","614789145967222832","614789146093051905","614789146093051916","614789146093051918","614789146093051919","614789146093051925","614789146093051926","614789146093051942","614789146093051943","614789146093051944","614789146093051946","614789146231463943","614789146231463944","614789146231463949","614789146231463961","614789146231463968","614789146231463970","614789146231463979","614789146382458889","614789146382458891","614789146382458902","614789146382458910","614789146382458924","614789146382458927","614789146382458928","614789146382458929","614789146516676612","614789146516676614","614789146516676615","614789146516676619","614789146516676629","614789146516676631","614789146516676637","614789146516676650","614789146516676656","614789146655088641","614789146655088653","614789146655088660","614789146655088663","614789146655088664","614789146655088676","614789146655088680","614789146655088684","614789146655088685","614789146655088686","614789146902552578","614789146902552582","614789146902552584","614789146902552586","614789146902552588","614789146902552603","614789146902552610","614789147045158915","614789147045158917","614789147045158919","614789147045158923","614789147045158929","614789147045158933","614789147045158937","614789147045158939","614789147045158940","614789147045158952","614789147045158958","614789147045158959","614789147045158961","614789147191959561","614789147191959564"};
        List<String> videos=new ArrayList<>();
    	for(String topId:topIds) {
    		videos.add(topId);
    	}
    	
        String[] exceptIds=new String[]{"614789417711984647","614790204890570753","614790185147981826","614790036212441125","614789855941255211","614789611706933252","614789708884762633","614789316838973458","614789323029766150","614789330483044356","614789335595900963","614789365035720711","614789379678035971","614789376813326360","614789386925793327","614789384040112169","614789385470369839","614789385470369838","614789378243584033","614789384040112172","614789385470369837","614789394190327852","614789395658334225","614789417711984647","614789425651802147","614789434338205731","614789435881709581","614789437441990684","614789434338205708","614789448624005132","614789442168971310","614789445365030939","614789455993397256","614789462645563425","614789467536121866","614789474196676634","614789469197066284","614789498330701834","614789524238917638","614789634838519814","614789855941255211","614790036212441125"};
        List<String> exceptVideoIds=new ArrayList<>();
    	for(String exceptId:exceptIds) {
    		exceptVideoIds.add(exceptId);
    	}
    	videos.removeAll(exceptVideoIds);
    	
    	List<String> ids=skPublishVideoDAO.selectIdsByIds(videos);
    	if(!CollectionUtils.isEmpty(ids)) {
    		logger.info("总共同步视频数:"+ids.size());
    		int errorCount=0;
        	for(String id:ids) {
        		UpdatePublishVideoCreateTime skPublishVideo=new UpdatePublishVideoCreateTime();
        		skPublishVideo.setId(id);
        		Calendar calendar=Calendar.getInstance();
        		calendar.add(Calendar.MONTH, 1);
        		skPublishVideo.setCreateTime(calendar.getTime());
        		try {
        			skPublishVideoDAO.updateCreateTime(skPublishVideo);
    			} catch (Exception e) {
    				logger.error(e.getMessage(),e);
    				errorCount++;
    			}
        	}
        	logger.info("更改时间完成,失败："+errorCount+"个");
    	}
		return BaseResponse.newSuccess();
	}
	
    @GetMapping("/deletesmallvideo")
    @IgnoreClientToken
	public BaseResponse deleteSmallVideo() {
    	redisService.del(RecommendEnum.SMALLVIDEOTOTAL.getKey());
		return BaseResponse.newSuccess();
    }
	
}
